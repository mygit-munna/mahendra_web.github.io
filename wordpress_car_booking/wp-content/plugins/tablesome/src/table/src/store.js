import reducersClass from"./reducers";import filterValues,{months,dateOperatorsDefinate,dateOperatorsIndefinate,absoluteContextuals,relativeContextuals}from"./../values/filterValues";import{tablesome_format,tablesome_isValid,tablesome_PHPDate}from"./../src/wrapper/date-fns";import{LexoRank}from"lexorank";import{writable,readable,derived,get}from"svelte/store";import WorkflowOptions from"../svelte/settings/workflow/utils/options.js";import WorkflowOptionsGetter from"./../svelte/settings/workflow/utils/optionsGetter";import WorkflowEventHandler from"./../svelte/settings/workflow/utils/eventHandler";class Store{tableTitle;mode;rows;tableID;isAdminUser;columns;rowLimit;columnLimit;currentPage;lastColumnID;lastStateRecordID;optionsStatus;filters;sortOrder;sortField;triggers;columnsInserted;columnsDuplicated;columnsDeleted;recordsUpdated;recordsDeleted;recordsInserted;searchQuery;activeRowIndex;activeCellIndex;activeColumnIndex;sfsRecords;viewableRecords;numOfTotalPages;manipulators;computedFilterOptions;constructor(e){this.tableID=e.tableID,this.isAdminUser=e.isAdminUser,this.mode=writable(e.mode||"editor"),this.hooks=e.hooks,this.columns=writable(e.columns),this.columnLimit=e.columnLimit,this.rows=writable(e.rows),this.tableTitle=readable(e.tableTitle),this.rowLimit=e.rowLimit,this.editorState=writable(e.editorState||{}),this.display=writable(e.display||{}),this.style=writable(e.style||{});let t={fields:e.accessControl?e.accessControl:{},options:{roles:[]}};this.accessControl=writable(t),this.isChangesMadeInTable=writable(!1),this.lastColumnID=e.lastColumnID||"",this.currentPage=writable(0),this.lastColumnID=writable(e.lastColumnID||1),this.lastStateRecordID=writable(e.lastStateRecordID||1),this.filters=writable(e.filters||[]);let s=new WorkflowOptionsGetter(this),r=new WorkflowEventHandler(this),o={triggers:e.triggers&&e.triggers.length?e.triggers:[{}],options:WorkflowOptions,optionsStatus:{},optionsGetter:s.getter,eventHandler:r.eventHandler};this.workflow=writable(o),this.optionsStatus=writable({isFilterOptionActive:!1,focusElement:""}),this.columnsInserted=writable([]),this.columnsDuplicated=writable([]),this.columnsDeleted=writable([]),this.recordsUpdated=writable(e.recordsUpdated||[]),this.recordsDeleted=writable([]),this.recordsInserted=writable([]),this.searchQuery=writable(null),this.sortOrder=writable(e.sort?.order??"desc"),this.sortField=writable(e.sort?.field??"created_at"),this.activeColumnIndex=writable(e.sort?.index??-1),this.activeRowIndex=writable(null),this.activeEditableRowIndex=writable(null),this.activeCellIndex=writable(null);const i=get(this.rows),l=get(this.columns),a=get(this.recordsInserted);if(0==l.length&&0==i.length&&0==this.tableID&&0==get(this.filters).length){l.push({id:get(this.lastColumnID),name:"Column Name",format:"text"});let e={record_id:0,stateRecordID:get(this.lastStateRecordID),content:[{type:"text",value:"",html:""}],rank_order:LexoRank.min().genNext().toString(),created_at:tablesome_PHPDate(),updated_at:tablesome_PHPDate()};i.push(e),a.push(e),this.columns.set(l),this.rows.set(i),this.recordsInserted.set(a)}this.reducers=new reducersClass(e.hooks),this.manipulators=derived([this.columns,this.currentPage,this.searchQuery,this.filters,this.sortOrder,this.sortField,this.activeColumnIndex,this.display,this.mode],(([e,t,s,r,o,i,l,a,n])=>({pagination:{numOfRecordsPerPage:"read-only"==n?a.numOfRecordsPerPage:10,currentPage:t},search:s,columns:e,filters:r,tableSort:{sortingBy:a.sortingBy,sortingOrder:a.sortingOrder,mode:n},sort:{order:o,field:i,column:e[l],index:l}}))),this.sfsRecords=derived([this.rows,this.manipulators],(([e,t])=>this.reducers.getSfsRecords(e,t))),this.viewableRecords=this.getViewableRecords(),this.numOfTotalPages=this.getNumOfTotalPages(),this.calculatedColumnValues=this.getCalculatedColumnValues(),this.computedFilterOptions=this.getComputedFilterOptions()}getNumOfTotalPages(){return derived([this.sfsRecords,this.mode,this.display],(([e,t,s])=>{let r="read-only"==t?s.numOfRecordsPerPage:10;return Math.ceil(e.length/r)}))}updateEditorState(e,t){this.editorState.update((s=>(s[e]=t,s)))}setDisplayField(e,t){this.display.update((s=>(s[e]=t,s)))}setAccessControlField(e,t,s="fields"){this.accessControl.update((r=>(r[s][e]=t,r)))}setStyleField(e,t){this.style.update((s=>(s[e]=t,s)))}getCalculatedColumnValues(){return derived([this.sfsRecords,this.columns],(([e,t])=>{let s=[];return t.forEach(((t,r)=>{let o="";if("number"==t.format&&t.calculate&&"none"!=t.calculate){o=0;let s=0,i=0,l=0,a=0,n=0,d=0;const c=e=>(e=parseFloat(e),isNaN(e)?0:e);switch(e.forEach((e=>{let t=c(e.content[r].value);t?(s+=t,0==i?(l=t,a=t):(l=Math.min(l,t),a=Math.max(a,t)),n++):d++,i++})),t.calculate){case"sum":o=s;break;case"average":o=s/n;break;case"count":o=i;break;case"min":o=l;break;case"max":o=a;break;case"non_empty_count":o=n;break;case"empty_count":o=d}o=+o.toFixed(3)}s.push(o)})),s}))}getComputedFilterOptions(){return derived(this.filters,(e=>(e.forEach((e=>{e.availableOperators=this.getOperators(e.format,e.contextual.value);let t=e.operator.value;return-1==e.availableOperators.findIndex((e=>e.value===t))&&(e.operator=e.availableOperators[0]),e.availableContextuals=this.getContextuals(t),e.availableMonths=months,e})),e)))}getOperators(e,t){let s=filterValues[e];return"date"==e&&("month"==t||"year"==t||"exact_date"==t||null==t?(s=[...dateOperatorsDefinate],s.splice(2,0,...dateOperatorsIndefinate)):s=[...dateOperatorsDefinate]),s}getContextuals(e){let t=[...relativeContextuals];return"="!=e&&"!="!=e&&null!=e||(t=[...absoluteContextuals,...relativeContextuals]),t}getViewableRecords(){return derived([this.sfsRecords,this.manipulators],(([e,t])=>this.reducers.getViewableRecords(e,t)))}setCurrentPage(e){this.currentPage.set(e)}setIsChangesMadeInTable(e){this.isChangesMadeInTable.set(e)}setOptionStatus(e){this.optionsStatus.hasOwnProperty(e.name)&&(this.optionsStatus[e.name]=e.value)}setSearchQuery(e){this.searchQuery.set(e)}setSortOrder(e){this.sortOrder.set(e)}addColumn(e,t){const s=get(this.rows),r=get(this.columns),o=this._getIncrementedColumnID();let i=r.length;null!==e&&(i="left"==t?e:e+1);let l={id:o,name:"Column Name",format:"text"};r.splice(i,0,l),s.map((e=>{e.content.splice(i,0,{type:"text",value:"",html:""})})),this.columns.set(r),this.rows.set(s),this.insertColumn(i)}moveColumn(e,t){const s=get(this.rows),r=get(this.columns);if(0==e&&"left"==t||e==r.length-1&&"right"==t)return;let o="left"==t?e-1:e+1,i=r[e];r.splice(e,1),r.splice(o,0,i),s.map((t=>{let s=t.content[e];t.content.splice(e,1),t.content.splice(o,0,s)})),this.columns.set(r),this.rows.set(s)}insertColumn(e){if("0"==this.tableID)return;const t=get(this.columns)[e];t.index=e;const s=get(this.columnsInserted);s.push(t),this.columnsInserted.set(s)}deleteColumn(e){this.sortOrder.set(null);const t=get(this.rows),s=get(this.columns),r=get(this.columnsDeleted);r.push(parseInt(s[e].id)),s.splice(e,1),t.map((t=>{t.content.splice(e,1)})),this.columns.set(s),this.rows.set(t),this.columnsDeleted.set(r),this.activeColumnIndex.set(null)}duplicateColumn(e){const t=get(this.rows),s=get(this.columns),r=this._getIncrementedColumnID();let o=e+1,i=Object.assign({},s[e]);i.id=r,s.splice(o,0,i),t.map((t=>{let s=Object.assign({},t.content[e]);t.content.splice(o,0,s)})),this.columns.set(s),this.rows.set(t),this.columnDuplicate(e)}columnDuplicate(e){if("0"==this.tableID)return;let t={index:e,id:get(this.columns)[e].id};const s=get(this.columnsDuplicated);s.push(t),this.columnsDuplicated.set(s)}addRow(e){e=parseInt(e);let t=this._getEmptyRow(e);const s=get(this.rows),r=get(this.columns);for(let e=0;e<r.length;e++)t.content.push({type:r[e].format,value:"",html:""});s.splice(e+1,0,t),this.rows.set(s),this.recordInsert(e)}recordDuplicate(e){e=parseInt(e);const t=this._getEmptyRow(e),s=get(this.rows);t.content=JSON.parse(JSON.stringify(s[e].content)),s.splice(e+1,0,t),this.rows.set(s),this.recordInsert(e)}recordDragged(e,t,s){let r,o;const i=get(this.rows);if(null!=e&&null!=t){const l=LexoRank.parse(i[e].rank_order),a=LexoRank.parse(i[t].rank_order);o=t-1,o=s>o?t:o,r=l.between(a).toString()}else if(null==e){o=t<=0?t:t-1,r=LexoRank.parse(i[t].rank_order).genPrev().toString()}else if(null==t){o=e+1,r=LexoRank.parse(i[e].rank_order).genNext().toString()}s!=o&&(i[s].rank_order=r,this._movePosition(i,s,o),this.rows.set(i),this.recordUpdate(s))}recordInsert(e){const t=get(this.recordsInserted),s=Object.assign({},get(this.rows)[e+1]);s.record_index=e+1,t.push(s),this.recordsInserted.set(t)}deleteRow(e){this.recordDelete(e);const t=get(this.rows);t.splice(e,1),this.rows.set(t)}recordDelete(e){if("0"==this.tableID)return;const t=get(this.rows)[e].record_id,s=get(this.recordsInserted),r=get(this.recordsDeleted),o=s.findIndex((t=>t.record_index===e));if(0==t&&-1!==o)return s.splice(o,1),void this.recordsInserted.set(s);r.push(t),this.recordsDeleted.set(r)}changeColumnName(e,t){this.columns.update((s=>(s[t].name=e,s)))}changeColumnOptions(e,t,s){this.columns.update((r=>(r[e][t]=s,r)))}changeCellType(e,t){const s=get(this.columns),r=get(this.rows);s[e].format!=t&&(s[e].format=t,"url"==t&&null==s[e].no_follow&&(s[e].no_follow=!1),"url"==t&&null==!s[e].open_in_new_tab&&(s[e].open_in_new_tab=!0),r.map((s=>{if("number"==t&&(s[e]=isNaN(Number(s[e]))||""==s[e]?"":Number(s[e])),"text"==t&&(s[e]=String(s[e])),"date"==t){let t=this.dateParse(s.content[e].value,s.content[e].html);s.content[e].type="date",s.content[e].value=t.value,s.content[e].html=t.html}})),this.columns.set(s),this.rows.set(r))}dateParse(e,t){const s={value:e,html:t};if(e&&"string"==typeof e&&"undefined"!=e&&NaN!=e&&"0"!=e){let t=parseInt(Date.parse(e));s.value=t,s.html=tablesome_isValid(t)?tablesome_format(t,tablesome_settings.date_format):""}return s}setActiveRowIndex(e){this.activeRowIndex.set(e)}setActiveEditableRowIndex(e){this.activeEditableRowIndex.set(e)}setActiveCellIndex(e){this.activeCellIndex.set(e)}deleteFilter(e){if(e>-1){const t=get(this.filters);t.splice(e,1),this.filters.set(t)}}addFilter(){const e={column_index:0,format:get(this.columns)[0].format,contextual:"",value:""};e.availableOperators=this.getOperators(e.format,""),e.operator=e.availableOperators[0],this.filters.update((t=>(t.push(e),t))),this.activeCellIndex.set(null)}updateFilters(e){let t=this;e.forEach((e=>{let s=e.column_index;e.column_index=s,e.format=t.columns[s].format})),this.filters=e}updateFilter(e,t){e.format=get(this.columns)[e.column_index].format,this.filters.update((s=>(s[t]=e,s)))}setActiveColumnIndex(e){this.activeColumnIndex.set(e)}setSortField(e){this.sortField.set(e)}updateCellValue(e){let t=e.rowIndex,s=get(this.rows),r={rows:s,rowIndex:t,cellData:e};r=this.hooks.applyFilters("getRecords",r),s=r.rows,"value"in e&&(s[t].content[e.cellIndex].value=e.value),"html"in e&&(s[t].content[e.cellIndex].html=e.html),"attachment"in e&&(s[t].content[e.cellIndex].attachment=e.attachment),s[t].updated_at=tablesome_PHPDate(),this.rows.set(s),this.recordUpdate(t)}recordUpdate(e){const t=get(this.rows),s=get(this.recordsInserted),r=s.findIndex((s=>s.stateRecordID===t[e].stateRecordID)),o=!s[e]&&-1==r,i=get(this.recordsUpdated),l=i.findIndex((s=>s.stateRecordID===t[e].stateRecordID));!i[e]&&-1==l&&o&&(i.push(t[e]),this.recordsUpdated.set(i))}_movePosition(e,t,s){const r=e[t];e.splice(t,1),e.splice(s,0,r)}_getEmptyRow(e){this.lastStateRecordID.update((e=>e+1));const t=get(this.rows),s=t.length,r=t[e].rank_order,o=e+1;let i="";if(s==o)i=LexoRank.parse(r).genNext().toString();else{const e=LexoRank.parse(r),s=LexoRank.parse(t[o].rank_order);i=e.between(s).toString()}return{record_id:0,stateRecordID:get(this.lastStateRecordID),content:[],rank_order:i,created_at:tablesome_PHPDate(),updated_at:tablesome_PHPDate()}}_getIncrementedColumnID(){return this.lastColumnID.set(get(this.lastColumnID)+1),get(this.lastColumnID)}}export default Store;